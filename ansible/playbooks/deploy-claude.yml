---
- name: Deploy Claude Configuration
  hosts: pai-server

  tasks:
    - name: Sync Claude configuration
      ansible.posix.synchronize:
        src: ../../pai-claude/
        dest: "/home/{{ ansible_user }}/.claude/"
        delete: false
        rsync_opts:
          - "--exclude=data/"
          - "--exclude=*.db"
          - "--exclude=statsig/"
          - "--exclude=projects/"
          - "--exclude=todos/"
          - "--exclude=debug/"
          - "--exclude=shell-snapshots/"
          - "--exclude=.credentials"
          - "--exclude=credentials.json"
          - "--exclude=settings.json"
          - "--exclude=settings.local.json"

    - name: Ensure data directories exist
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: "0755"
      loop:
        - "/home/{{ ansible_user }}/.claude/data"
        - "/home/{{ ansible_user }}/.claude/data/history"
        - "/home/{{ ansible_user }}/.claude/data/history/sessions"
        - "/home/{{ ansible_user }}/.claude/data/history/learnings"

    - name: Verify Claude configuration
      ansible.builtin.stat:
        path: "/home/{{ ansible_user }}/.claude/CLAUDE.md"
      register: claude_config

    - name: Print deployment status
      ansible.builtin.debug:
        msg: "Claude configuration deployed successfully"
      when: claude_config.stat.exists
