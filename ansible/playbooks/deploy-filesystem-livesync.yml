---
- name: Deploy Filesystem LiveSync
  hosts: pai-server
  vars_files:
    - ../inventory/group_vars/all/vault.yml

  tasks:
    - name: Ensure obsidian-vault directory exists
      ansible.builtin.file:
        path: "/home/{{ ansible_user }}/obsidian-vault"
        state: directory
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: "0755"

    - name: Check if filesystem-livesync is cloned
      ansible.builtin.stat:
        path: "/home/{{ ansible_user }}/filesystem-livesync"
      register: fls_dir

    - name: Clone filesystem-livesync
      ansible.builtin.git:
        repo: https://github.com/vrtmrz/filesystem-livesync.git
        dest: "/home/{{ ansible_user }}/filesystem-livesync"
        recursive: true
        version: master
      when: not fls_dir.stat.exists

    - name: Fix filesystem-livesync ownership
      ansible.builtin.file:
        path: "/home/{{ ansible_user }}/filesystem-livesync"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        recurse: true

    - name: Ensure dat directory exists
      ansible.builtin.file:
        path: "/home/{{ ansible_user }}/filesystem-livesync/dat"
        state: directory
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: "0755"

    - name: Create config.json
      ansible.builtin.template:
        src: templates/filesystem-livesync.config.json.j2
        dest: "/home/{{ ansible_user }}/filesystem-livesync/dat/config.json"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: "0600"

    - name: Install npm dependencies
      community.general.npm:
        path: "/home/{{ ansible_user }}/filesystem-livesync"
        state: present

    - name: Create systemd service
      ansible.builtin.template:
        src: templates/filesystem-livesync.service.j2
        dest: /etc/systemd/system/filesystem-livesync.service
        mode: "0644"
      become: true

    - name: Enable and start filesystem-livesync service
      ansible.builtin.systemd:
        name: filesystem-livesync
        enabled: true
        state: restarted
        daemon_reload: true
      become: true

    - name: Wait for initial sync
      ansible.builtin.pause:
        seconds: 5

    - name: Check service status
      ansible.builtin.command: systemctl status filesystem-livesync
      register: service_status
      changed_when: false
      failed_when: false

    - name: Print setup info
      ansible.builtin.debug:
        msg: |
          ========================================
          Filesystem LiveSync 部署完成！
          ========================================

          Vault 目錄: /home/{{ ansible_user }}/obsidian-vault
          服務狀態: {{ 'running' if 'active (running)' in service_status.stdout else 'check logs' }}

          常用命令:
          - 查看狀態: systemctl status filesystem-livesync
          - 查看日誌: journalctl -u filesystem-livesync -f
          - 重啟服務: sudo systemctl restart filesystem-livesync
          ========================================
